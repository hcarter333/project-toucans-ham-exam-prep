<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt GPT-4o audio</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
      line-height: 1.6;
    }
    .info {
      background: #e8f4ff;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #0066cc;
    }
    .input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    textarea {
      width: 100%; padding: 12px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit;
    }
    #systemPrompt { min-height: 60px; }
    #promptInput { min-height: 150px; }
    #responseJson { min-height: 200px; font-family: monospace; background: #f5f5f5; }
    select, button {
      padding: 8px 12px; font-size: 16px; border: 1px solid #ccc;
      border-radius: 4px; max-width: 200px;
    }
    button {
      background: #0066cc; color: white; border: none; cursor: pointer;
    }
    button:disabled { background: #cccccc; }
    button:hover:not(:disabled) { background: #0055aa; }
    .error { color: #cc0000; margin: 10px 0; }
    .player-container { margin: 20px 0; }
    audio { width: 100%; margin: 10px 0; }
    .transcript {
      background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0;
    }
    .json-container { margin-top: 20px; }
    .copy-button { margin-top: 8px; background: #4CAF50; }
    .copy-button:hover:not(:disabled) { background: #45a049; }
    .gist-button { background: #2ea44f; margin-right: 10px; }
    .gist-button:hover:not(:disabled) { background: #2c974b; }
    .gist-links { margin: 10px 0; }
    .gist-links a { display: block; margin: 5px 0; color: #0066cc; }
    #authLink { color: #0066cc; cursor: pointer; text-decoration: underline; }
    .select-group { display: flex; gap: 12px; }
  </style>
</head>
<body>
  <h1>Prompt GPT-4o audio</h1>
  <div class="info">
    Enter a prompt below and execute against the selected model to hear the results.
  </div>

  <div class="input-group">
    <label for="systemPrompt">System Prompt (optional):</label>
    <textarea id="systemPrompt" placeholder="Enter system prompt here..."></textarea>
    
    <label for="promptInput">User Prompt:</label>
    <textarea id="promptInput" placeholder="Enter your text here..."></textarea>
    
    <div class="select-group">
      <select id="modelSelect">
        <option value="gpt-4o-mini-audio-preview-2024-12-17">GPT-4o mini audio preview (Dec 17, 2024)</option>
        <option value="gpt-4o-audio-preview-2024-12-17">GPT-4o audio preview (Dec 17, 2024)</option>
        <option value="gpt-4o-audio-preview-2024-10-01">GPT-4o audio preview (Oct 1, 2024)</option>
      </select>
      <select id="voiceSelect">
        <optgroup label="Recommended voices">
          <option value="ash">Ash</option>
          <option value="ballad">Ballad</option>
          <option value="coral">Coral</option>
          <option value="sage">Sage</option>
          <option value="verse">Verse</option>
        </optgroup>
        <optgroup label="Less expressive">
          <option value="alloy">Alloy</option>
          <option value="echo">Echo</option>
          <option value="shimmer">Shimmer</option>
        </optgroup>
      </select>
    </div>
    <button id="submitBtn">Generate Speech</button>
  </div>
  
  <div id="error" class="error" style="display: none;"></div>
  <div id="playerContainer" class="player-container" style="display: none;">
    <audio id="audioPlayer" controls></audio>
    <button id="downloadBtn">Download Audio</button>
    <div id="transcript" class="transcript"></div>
  </div>

  <div id="jsonContainer" class="json-container" style="display: none;">
    <div id="gistContainer">
      <span id="authLinkContainer" style="display: none;">
        <a id="authLink">Authenticate with GitHub</a>
      </span>
      <button id="saveGistBtn" class="gist-button" style="display: none;">Save as Gist</button>
      <div id="gistLinks" class="gist-links"></div>
    </div>
    <h3>API Response:</h3>
    <textarea id="responseJson" readonly></textarea>
    <button id="copyJsonBtn" class="copy-button">Copy to clipboard</button>
  </div>

  <script>
    /* =========================
       Config / Utilities
    ========================= */
    const QUESTION_POOL_URL =
      "https://raw.githubusercontent.com/hcarter333/project-toucans-ham-exam-prep/refs/heads/main/extra_pool.json";
    const BASE = "https://api.openai.com/v1";

    const els = {
      promptInput: document.getElementById('promptInput'),
      systemPrompt: document.getElementById('systemPrompt'),
      modelSelect: document.getElementById('modelSelect'),
      voiceSelect: document.getElementById('voiceSelect'),
      submitBtn: document.getElementById('submitBtn'),
      errorDiv: document.getElementById('error'),
      playerContainer: document.getElementById('playerContainer'),
      audioPlayer: document.getElementById('audioPlayer'),
      downloadBtn: document.getElementById('downloadBtn'),
      transcriptDiv: document.getElementById('transcript'),
      jsonContainer: document.getElementById('jsonContainer'),
      responseJson: document.getElementById('responseJson'),
      copyJsonBtn: document.getElementById('copyJsonBtn'),
      saveGistBtn: document.getElementById('saveGistBtn'),
      authLinkContainer: document.getElementById('authLinkContainer'),
      authLink: document.getElementById('authLink'),
      gistLinks: document.getElementById('gistLinks'),
    };

    function showError(message) {
      els.errorDiv.textContent = message;
      els.errorDiv.style.display = 'block';
      els.playerContainer.style.display = 'none';
      els.jsonContainer.style.display = 'none';
    }
    function clearError() { els.errorDiv.style.display = 'none'; }

    function getAPIKey() {
      let apiKey = localStorage.getItem('openai_api_key');
      if (!apiKey) {
        apiKey = prompt('Please enter your OpenAI API Key:');
        if (apiKey) localStorage.setItem('openai_api_key', apiKey);
      }
      return apiKey;
    }

    async function openai(path, { method = 'POST', headers = {}, body } = {}) {
      const apiKey = getAPIKey();
      if (!apiKey) throw new Error('Missing OpenAI API key.');

      const isForm = (body instanceof FormData);
      const res = await fetch(`${BASE}${path}`, {
        method,
        headers: isForm
          ? { 'Authorization': `Bearer ${apiKey}`, ...headers }
          : { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json', ...headers },
        body: isForm ? body : (body ? JSON.stringify(body) : undefined),
      });

      const text = await res.text();
      if (!res.ok) throw new Error(`OpenAI ${path} failed: ${res.status} ${res.statusText} :: ${text}`);
      return text ? JSON.parse(text) : {};
    }

    /* =========================
       Vector Store Bootstrap
    ========================= */
    async function ensureVectorStore(jsonData) {
      let vsId = localStorage.getItem('vector_store_id');
      if (vsId) return vsId;

      const vs = await openai('/vector_stores', { body: { name: 'Ham Exam Pool (User-Owned)' } });
      vsId = vs.id;

      const form = new FormData();
      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
      form.append('file', blob, 'extra_pool.json');
      form.append('purpose', 'assistants');
      const file = await openai('/files', { body: form });

      await openai(`/vector_stores/${vsId}/files`, { body: { file_id: file.id } });
      await waitForFileReady(vsId, file.id);

      localStorage.setItem('vector_store_id', vsId);
      return vsId;
    }

    async function waitForFileReady(vectorStoreId, fileId, timeoutMs = 30000) {
      const start = Date.now();
      while (true) {
        const status = await openai(`/vector_stores/${vectorStoreId}/files/${fileId}`, { method: 'GET' });
        if (status.status === 'completed') return;
        if (status.status === 'failed') throw new Error('Vector store indexing failed');
        if (Date.now() - start > timeoutMs) throw new Error('Timed out waiting for indexing');
        await new Promise(r => setTimeout(r, 900));
      }
    }

    /* =========================
       PATH #1 — Retrieval
    ========================= */
    function extractResponsesOutputText(resp) {
      if (resp && Array.isArray(resp.output)) {
        for (const message of resp.output) {
          if (Array.isArray(message.content)) {
            const hit = message.content.find(c => c.type === 'output_text' && typeof c.text === 'string');
            if (hit) return hit.text;
          }
        }
      }
      return null;
    }
 let answText = ""
async function retrieveTextWithFileSearch({ system, user }) {
  const vsId = localStorage.getItem('vector_store_id');
  if (!vsId) throw new Error('No vector_store_id found.');
  answText = answText + " " + user;
  const resp = await openai('/responses', {
    body: {
      model: 'gpt-4.1-mini',
      input: [
        { role: 'system', content: system },
        { role: 'user',   content: answText }
      ],
      tools: [{ type: 'file_search', vector_store_ids: [vsId] }]
    }
  });

  // find the completed assistant message
  const completedMsg = resp.output.find(
    o => o.type === "message" && o.status === "completed"
  );
  const text = completedMsg?.content?.[0]?.text;

  if (!text) throw new Error('No completed message text found.');

  // show only the text in the textarea
  els.responseJson.value = text;
  els.jsonContainer.style.display = 'block';

    answText = answText + " " + text;

  return text;
}
    /* =========================
       PATH #2 — Audio
    ========================= */
    async function synthesizeAudioFromText({ model, voice, system, text }) {
      const messages = [];
      if (system && system.trim()) messages.push({ role: 'system', content: system });
      messages.push({ role: 'user', content: text });

      const payload = {
        model,
        modalities: ['text', 'audio'],
        audio: { voice, format: 'wav' },
        messages
      };

      const data = await openai('/chat/completions', { body: payload });
      els.responseJson.value = JSON.stringify(data, null, 2);
      els.jsonContainer.style.display = 'block';

      const audioData = data?.choices?.[0]?.message?.audio?.data;
      const transcript = data?.choices?.[0]?.message?.audio?.transcript || '';

      if (!audioData) throw new Error('No audio data on response');

      const bin = atob(audioData);
      const buf = new ArrayBuffer(bin.length);
      const u8 = new Uint8Array(buf);
      for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
      const blob = new Blob([u8], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);

      els.audioPlayer.src = url;
      els.transcriptDiv.textContent = transcript;
      els.playerContainer.style.display = 'block';

      els.downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = 'speech.wav';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    }

    /* =========================
       App Init + Button Flow
    ========================= */
    let jsonPool = null;

    async function init() {
      try {
        const res = await fetch(QUESTION_POOL_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        jsonPool = await res.json();
        await ensureVectorStore(jsonPool);
      } catch (e) {
        console.error('Init failed:', e);
        alert('Could not initialize: ' + e.message);
      }
    }
    window.addEventListener('DOMContentLoaded', init);

    els.submitBtn.addEventListener('click', async () => {
      try {
        clearError();
        els.submitBtn.disabled = true;
        els.submitBtn.textContent = 'Processing...';

        const system = els.systemPrompt.value || '';
        const userPrompt = els.promptInput.value || 'Read a short sample aloud.';

        const retrievedText = await retrieveTextWithFileSearch({
          system: system || 'Use the File Search knowledge base. If no evidence is found, say NOT_FOUND.',
          user: userPrompt
        });

        console.log(retrievedText);

        //await synthesizeAudioFromText({
        //  model: els.modelSelect.value,
        //  voice: els.voiceSelect.value,
        //  system: 'Speak the provided text clearly, with natural pacing.',
        //  text: retrievedText
        //});

      } catch (err) {
        console.error(err);
        showError(err.message || 'An error occurred');
      } finally {
        els.submitBtn.textContent = 'Generate Speech';
        els.submitBtn.disabled = false;
      }
    });

    /* =========================
       GitHub Gist Auth Handlers
    ========================= */
    function checkGithubAuth() {
      const token = localStorage.getItem('github_token');
      if (token) {
        els.authLinkContainer.style.display = 'none';
        els.saveGistBtn.style.display = 'inline-block';
      } else {
        els.authLinkContainer.style.display = 'inline-block';
        els.saveGistBtn.style.display = 'none';
      }
    }

    function startAuthPoll() {
      const pollInterval = setInterval(() => {
        if (localStorage.getItem('github_token')) {
          checkGithubAuth();
          clearInterval(pollInterval);
        }
      }, 1000);
    }

    els.authLink.addEventListener('click', () => {
      window.open('https://tools.simonwillison.net/github-auth', 'github-auth', 'width=600,height=800');
      startAuthPoll();
    });

    async function createGist() {
      const token = localStorage.getItem('github_token');
      if (!token) {
        checkGithubAuth();
        return;
      }

      try {
        els.saveGistBtn.disabled = true;
        els.saveGistBtn.textContent = 'Saving...';

        const response = await fetch('https://api.github.com/gists', {
          method: 'POST',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            description: 'GPT-4o audio response',
            public: true,
            files: {
              'response.json': {
                content: els.responseJson.value
              }
            }
          })
        });

        if (!response.ok) {
          throw new Error('Failed to create gist');
        }

        const data = await response.json();
        const gistId = data.id;
        const gistUrl = data.html_url;
        const playerUrl = `https://tools.simonwillison.net/gpt-4o-audio-player?gist=${gistId}`;

        els.gistLinks.innerHTML = `
          <a href="${gistUrl}" target="_blank">View Gist</a>
          <a href="${playerUrl}" target="_blank">Audio player</a>
        `;
      } catch (error) {
        console.error('Gist creation failed:', error);
        localStorage.removeItem('github_token');
        checkGithubAuth();
      } finally {
        els.saveGistBtn.disabled = false;
        els.saveGistBtn.textContent = 'Save as Gist';
      }
    }

    els.saveGistBtn.addEventListener('click', createGist);
    checkGithubAuth();
  </script>
</body>
</html>
